# Simpleton LLM Service - mise configuration
# Install mise: curl https://mise.run | sh

[tools]
bun = "latest"
python = "3.11"
uv = "latest"

[tasks.start]
description = "Start all services"
run = """
echo "Starting Simpleton services..."
docker-compose up -d
echo "Services started! API: http://localhost:8000/docs"
"""

[tasks.stop]
description = "Stop all services"
run = "docker-compose down"

[tasks.restart]
description = "Restart all services"
run = "docker-compose restart"

[tasks.logs]
description = "View service logs"
run = "docker-compose logs -f"

[tasks."logs:api"]
description = "View API logs only"
run = "docker-compose logs -f simpleton"

[tasks."logs:ollama"]
description = "View Ollama logs only"
run = "docker-compose logs -f ollama"

[tasks.build]
description = "Rebuild containers"
run = "docker-compose build"

[tasks.clean]
description = "Stop and remove all containers/volumes"
run = """
echo "Cleaning up..."
docker-compose down -v
echo "Cleanup complete!"
"""

[tasks."pull-models"]
description = "Pull recommended models"
run = """
echo "Pulling recommended models..."
echo "This may take a while depending on your internet connection..."
docker exec simpleton-ollama ollama pull qwen2.5:7b
docker exec simpleton-ollama ollama pull nomic-embed-text
echo "Models pulled successfully!"
"""

[tasks."list-models"]
description = "List available models"
run = """
echo "Available models:"
docker exec simpleton-ollama ollama list
"""

[tasks."shell:api"]
description = "Open shell in API container"
run = "docker exec -it simpleton-api /bin/bash"

[tasks."shell:ollama"]
description = "Open shell in Ollama container"
run = "docker exec -it simpleton-ollama /bin/bash"

[tasks.test]
description = "Test API health"
run = """
echo "Testing API health..."
curl -s http://localhost:8000/health | python -m json.tool || echo "API not responding"
"""

# Local development tasks (uv)
[tasks.install]
description = "Install dependencies with uv"
run = """
if ! command -v uv &> /dev/null; then
    echo "uv not found. Install: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi
uv sync
"""

[tasks.dev]
description = "Install with dev dependencies"
run = """
if ! command -v uv &> /dev/null; then
    echo "uv not found. Install: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi
uv sync --extra dev
"""

[tasks.run]
description = "Run locally (requires Ollama)"
run = """
if ! command -v ollama &> /dev/null; then
    echo "Ollama not found. Install from https://ollama.com"
    exit 1
fi
echo "Make sure Ollama is running: ollama serve"
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
"""

[tasks.lint]
description = "Run linting"
run = "uv run ruff check app/"

[tasks.format]
description = "Format code"
run = "uv run ruff format app/"

[tasks."format:check"]
description = "Check code formatting without making changes"
run = "uv run ruff format --check app/"
